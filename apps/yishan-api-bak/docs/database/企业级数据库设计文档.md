# 企业级数据库设计文档

## 1. 设计概述

本数据库设计遵循企业级最佳实践，采用规范化设计，确保数据完整性、一致性和可扩展性。设计遵循以下原则：

- **第三范式（3NF）**：消除数据冗余，确保数据依赖关系正确
- **审计追踪**：完整的创建、更新、删除记录追踪
- **权限控制**：基于角色的访问控制（RBAC）
- **数据完整性**：通过外键、约束、触发器保证
- **性能优化**：适当的索引和分区策略
- **国际化支持**：预留多语言扩展能力

## 2. 核心表设计

### 2.1 系统用户表 (sys_user)

**用途**：存储系统用户基础信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | 邮箱地址 |
| phone | VARCHAR(20) | UNIQUE | 手机号码 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| salt | VARCHAR(32) | NOT NULL | 密码盐值 |
| real_name | VARCHAR(50) | NOT NULL | 真实姓名 |
| avatar | VARCHAR(500) | | 头像URL |
| gender | TINYINT(1) | DEFAULT 0 | 性别(0-未知,1-男,2-女) |
| birth_date | DATE | | 出生日期 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用,2-锁定) |
| last_login_time | DATETIME | | 最后登录时间 |
| last_login_ip | VARCHAR(45) | | 最后登录IP |
| login_count | INT(11) | DEFAULT 0 | 登录次数 |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

**索引设计**：
- PRIMARY KEY (`id`)
- UNIQUE KEY `uk_username` (`username`)
- UNIQUE KEY `uk_email` (`email`)
- UNIQUE KEY `uk_phone` (`phone`)
- KEY `idx_status` (`status`)
- KEY `idx_created_at` (`created_at`)
- KEY `idx_deleted_at` (`deleted_at`)

### 2.2 系统角色表 (sys_role)

**用途**：定义系统角色信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 角色ID |
| role_code | VARCHAR(50) | UNIQUE, NOT NULL | 角色编码 |
| role_name | VARCHAR(100) | NOT NULL | 角色名称 |
| role_type | TINYINT(1) | DEFAULT 1 | 角色类型(1-系统角色,2-自定义角色) |
| description | VARCHAR(500) | | 角色描述 |
| sort_order | INT(11) | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

### 2.3 用户角色关联表 (sys_user_role)

**用途**：用户与角色的多对多关联关系

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 关联ID |
| user_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_user(id) | 用户ID |
| role_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_role(id) | 角色ID |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| deleted_at | DATETIME | | 软删除时间 |

**复合索引**：
- UNIQUE KEY `uk_user_role` (`user_id`, `role_id`, `deleted_at`)
- KEY `idx_role_id` (`role_id`)

### 2.4 部门表 (sys_department)

**用途**：组织架构中的部门信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 部门ID |
| dept_code | VARCHAR(50) | UNIQUE, NOT NULL | 部门编码 |
| dept_name | VARCHAR(100) | NOT NULL | 部门名称 |
| parent_id | BIGINT(20) | DEFAULT 0 | 父部门ID(0为根部门) |
| ancestors | VARCHAR(500) | NOT NULL | 祖级列表(如:0,1,5,8) |
| leader_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 负责人ID |
| phone | VARCHAR(20) | | 联系电话 |
| email | VARCHAR(100) | | 邮箱地址 |
| sort_order | INT(11) | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

### 2.5 岗位表 (sys_position)

**用途**：组织中的岗位/职位信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 岗位ID |
| position_code | VARCHAR(50) | UNIQUE, NOT NULL | 岗位编码 |
| position_name | VARCHAR(100) | NOT NULL | 岗位名称 |
| position_level | TINYINT(1) | DEFAULT 1 | 岗位级别(1-普通员工,2-主管,3-经理,4-总监,5-副总,6-总经理) |
| description | VARCHAR(500) | | 岗位描述 |
| sort_order | INT(11) | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

### 2.6 用户部门岗位关联表 (sys_user_dept_position)

**用途**：用户与部门、岗位的多对多关联关系

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 关联ID |
| user_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_user(id) | 用户ID |
| dept_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_department(id) | 部门ID |
| position_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_position(id) | 岗位ID |
| is_primary | TINYINT(1) | DEFAULT 0 | 是否主部门(0-否,1-是) |
| entry_date | DATE | | 入职日期 |
| leave_date | DATE | | 离职日期 |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |

**复合索引**：
- UNIQUE KEY `uk_user_dept_position` (`user_id`, `dept_id`, `position_id`, `deleted_at`)
- KEY `idx_dept_id` (`dept_id`)
- KEY `idx_position_id` (`position_id`)

### 2.7 菜单权限表 (sys_menu)

**用途**：系统菜单和功能权限定义

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 菜单ID |
| menu_code | VARCHAR(50) | UNIQUE, NOT NULL | 菜单编码 |
| menu_name | VARCHAR(100) | NOT NULL | 菜单名称 |
| menu_type | TINYINT(1) | NOT NULL | 菜单类型(1-目录,2-菜单,3-按钮) |
| parent_id | BIGINT(20) | DEFAULT 0 | 父菜单ID(0为根菜单) |
| path | VARCHAR(200) | | 路由地址 |
| component | VARCHAR(200) | | 组件路径 |
| permission | VARCHAR(100) | | 权限标识 |
| icon | VARCHAR(100) | | 菜单图标 |
| sort_order | INT(11) | DEFAULT 0 | 排序 |
| is_frame | TINYINT(1) | DEFAULT 1 | 是否外链(0-是,1-否) |
| is_cache | TINYINT(1) | DEFAULT 0 | 是否缓存(0-缓存,1-不缓存) |
| is_visible | TINYINT(1) | DEFAULT 1 | 是否显示(0-隐藏,1-显示) |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

### 2.8 角色菜单关联表 (sys_role_menu)

**用途**：角色与菜单的权限关联

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 关联ID |
| role_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_role(id) | 角色ID |
| menu_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_menu(id) | 菜单ID |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| deleted_at | DATETIME | | 软删除时间 |

**复合索引**：
- UNIQUE KEY `uk_role_menu` (`role_id`, `menu_id`, `deleted_at`)
- KEY `idx_menu_id` (`menu_id`)

### 2.9 数据字典表 (sys_dict_type)

**用途**：系统数据字典类型定义

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 字典类型ID |
| dict_code | VARCHAR(50) | UNIQUE, NOT NULL | 字典编码 |
| dict_name | VARCHAR(100) | NOT NULL | 字典名称 |
| description | VARCHAR(500) | | 字典描述 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

### 2.10 数据字典详情表 (sys_dict_data)

**用途**：数据字典的具体选项值

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | BIGINT(20) | PRIMARY KEY, AUTO_INCREMENT | 字典数据ID |
| dict_type_id | BIGINT(20) | NOT NULL, FOREIGN KEY REFERENCES sys_dict_type(id) | 字典类型ID |
| dict_label | VARCHAR(100) | NOT NULL | 字典标签 |
| dict_value | VARCHAR(100) | NOT NULL | 字典键值 |
| css_class | VARCHAR(100) | | CSS样式类名 |
| list_class | VARCHAR(100) | | 表格回显样式 |
| is_default | TINYINT(1) | DEFAULT 0 | 是否默认(0-否,1-是) |
| sort_order | INT(11) | DEFAULT 0 | 排序 |
| status | TINYINT(1) | DEFAULT 1 | 状态(0-禁用,1-启用) |
| creator_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 创建人ID |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updater_id | BIGINT(20) | FOREIGN KEY REFERENCES sys_user(id) | 更新人ID |
| updated_at | DATETIME | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | DATETIME | | 软删除时间 |
| version | INT(11) | DEFAULT 1 | 乐观锁版本号 |

## 3. 数据库设计规范

### 3.1 命名规范

- **表名**：使用小写字母，单词间用下划线分隔，前缀为`sys_`
- **字段名**：使用小写字母，单词间用下划线分隔
- **索引名**：`uk_`表示唯一索引，`idx_`表示普通索引
- **外键名**：`fk_表名_字段名`

### 3.2 迁移文件规范

- **文件命名**：使用序号和描述性名称，格式：`{序号}.{操作}.{表名}.sql`
- **主表与关联表合并原则**：相关联的主表和关联表应合并到同一个迁移文件中
  - 例如：`003.do.roles.sql` 包含 `sys_role` 表和 `sys_user_role` 关联表
  - 例如：`008.do.departments.sql` 包含 `sys_department` 表和相关关联表
- **回滚文件对应**：回滚文件应包含所有相关表的删除操作，按依赖关系逆序执行
- **避免过度拆分**：不要将紧密关联的表拆分到不同的迁移文件中

### 3.3 数据类型规范

- **主键ID**：统一使用BIGINT(20) AUTO_INCREMENT
- **状态字段**：使用TINYINT(1) 0表示禁用，1表示启用
- **布尔字段**：使用TINYINT(1) 0表示否，1表示是
- **时间字段**：使用DATETIME类型
- **字符串**：根据实际需求选择VARCHAR长度，避免使用TEXT类型

### 3.3 约束规范

- **主键**：每个表必须有主键，统一命名为id
- **外键**：所有关联字段必须建立外键约束
- **唯一约束**：业务唯一性字段必须建立唯一索引
- **非空约束**：业务上不允许为空的字段必须设置NOT NULL
- **默认值**：所有字段都应该设置合理的默认值

### 3.4 审计字段规范

每个业务表必须包含以下审计字段：
- `creator_id`：创建人ID
- `created_at`：创建时间
- `updater_id`：更新人ID
- `updated_at`：更新时间
- `deleted_at`：软删除时间（NULL表示未删除）
- `version`：乐观锁版本号

### 3.5 索引规范

- **主键索引**：系统自动创建
- **唯一索引**：业务唯一性字段
- **普通索引**：常用于查询条件的字段
- **复合索引**：多字段组合查询场景
- **前缀索引**：对于长文本字段的前缀索引

### 3.6 软删除机制

- 使用`deleted_at`字段实现软删除
- 所有查询自动过滤已删除数据
- 唯一索引需要包含`deleted_at`字段以确保唯一性

## 4. 数据完整性保证

### 4.1 外键约束

所有关联关系都通过外键约束保证数据完整性，包括：
- 级联更新（ON UPDATE CASCADE）
- 限制删除（ON DELETE RESTRICT）
- 软删除处理

### 4.2 触发器设计

创建触发器自动维护以下字段：
- `ancestors`：部门层级路径自动计算
- `updated_at`：更新时间自动更新
- `version`：版本号自动递增

### 4.3 存储过程

提供常用操作的存储过程：
- 用户批量授权角色
- 部门层级调整
- 数据字典缓存刷新

## 5. 性能优化策略

### 5.1 索引优化

- 高频查询字段建立索引
- 复合索引遵循最左前缀原则
- 定期分析和优化索引

### 5.2 查询优化

- 避免全表扫描
- 使用覆盖索引
- 合理使用分页查询

### 5.3 缓存策略

- 数据字典数据缓存
- 用户权限缓存
- 部门层级结构缓存

## 6. 安全设计

### 6.1 数据加密

- 密码使用bcrypt加密存储
- 敏感信息字段加密
- 传输层SSL加密

### 6.2 权限控制

- 基于角色的访问控制（RBAC）
- 数据行级权限控制
- 操作审计日志

### 6.3 备份策略

- 定期全量备份
- 实时增量备份
- 异地容灾备份

## 7. 扩展性设计

### 7.1 水平扩展

- 分库分表策略预留
- 读写分离架构支持
- 分布式事务处理

### 7.2 垂直扩展

- 预留扩展字段
- 模块化表结构设计
- 插件式权限扩展

## 8. 监控与维护

### 8.1 性能监控

- 慢查询日志监控
- 索引使用情况监控
- 表空间使用监控

### 8.2 数据质量监控

- 数据一致性检查
- 重复数据检测
- 完整性约束检查

## 9. 实施计划

### 第一阶段：基础表结构
- 创建用户、角色、部门、岗位核心表
- 建立基础关联关系
- 实现基础权限控制

### 第二阶段：功能扩展
- 添加菜单权限管理
- 实现数据字典功能
- 完善审计日志

### 第三阶段：性能优化
- 索引优化
- 查询优化
- 缓存实现

### 第四阶段：安全加固
- 数据加密
- 权限细化
- 安全审计

## 10. 注意事项

1. **字符集统一**：所有表统一使用utf8mb4字符集
2. **时区处理**：统一使用UTC时间存储，应用层转换时区
3. **事务处理**：所有写操作必须使用事务
4. **异常处理**：完善的错误处理和回滚机制
5. **文档维护**：保持设计与实现的文档同步更新