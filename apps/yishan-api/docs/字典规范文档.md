# 字典规范文档

## 概述

本系统采用字典表设计来管理各种业务枚举值，通过统一的字典管理实现数据的标准化和可维护性。字典数据分为字典类型（DictType）和字典数据（DictData）两个层级。

## 字典结构设计

### 字典类型表（sys_dict_type）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | int | 主键ID | 1 |
| name | varchar(100) | 字典名称 | 用户性别 |
| type | varchar(100) | 字典类型（唯一） | user_gender |
| status | tinyint | 状态（0-禁用，1-启用） | 1 |
| sort_order | int | 排序 | 1 |
| remark | varchar(255) | 备注 | 用户性别字典 |

### 字典数据表（sys_dict_data）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| id | int | 主键ID | 1 |
| type_id | int | 字典类型ID | 1 |
| label | varchar(100) | 显示标签 | 男 |
| value | varchar(100) | 数据值 | 1 |
| status | tinyint | 状态（0-禁用，1-启用） | 1 |
| sort_order | int | 排序 | 1 |
| tag | varchar(50) | 标签样式 | success |
| remark | varchar(255) | 备注 | 男性 |
| is_default | boolean | 是否默认值 | false |

## 当前系统字典配置

### 1. 用户性别字典（user_gender）

| 标签 | 值 | 排序 | 说明 |
|------|----|------|------|
| 保密 | 0 | 0 | 未知或未设置 |
| 男 | 1 | 1 | 男性 |
| 女 | 2 | 2 | 女性 |

**使用场景**：用户个人信息中的性别字段

**数据流规范**：
- 数据库存储：数字类型（0, 1, 2）
- 前端传入：字符串类型（"0", "1", "2"）
- 响应返回：字符串类型（"0", "1", "2"）

### 2. 用户状态字典（user_status）

| 标签 | 值 | 排序 | 说明 |
|------|----|------|------|
| 禁用 | 0 | 0 | 账号被禁用 |
| 启用 | 1 | 1 | 账号正常启用 |
| 拉黑 | 2 | 2 | 账号被拉黑 |

**使用场景**：用户账号状态管理

**数据流规范**：
- 数据库存储：数字类型（0, 1, 2）
- 前端传入：字符串类型（"0", "1", "2"）
- 响应返回：字符串类型（"0", "1", "2"）

### 3. 默认状态字典（default_status）

| 标签 | 值 | 排序 | 说明 |
|------|----|------|------|
| 禁用 | 0 | 0 | 禁用状态 |
| 启用 | 1 | 1 | 启用状态（默认） |

**使用场景**：通用启用/禁用状态，如部门、岗位、菜单、角色等

**应用模块**：
- **部门管理**：部门启用/禁用状态
- **岗位管理**：岗位启用/禁用状态  
- **菜单管理**：菜单启用/禁用状态
- **角色管理**：角色启用/禁用状态

**数据流规范**：
- 数据库存储：数字类型（0, 1）
- 前端传入：字符串类型（"0", "1"）
- 响应返回：字符串类型（"0", "1"）

## 数据类型转换规范

### 类型转换流程

1. **前端到后端**：
   - 前端传入字符串类型（"0", "1", "2"）
   - 后端Schema验证字符串格式
   - 业务逻辑层转换为数字类型存储

2. **后端到前端**：
   - 数据库查询获取数字类型
   - 模型层转换为字符串类型响应
   - 前端接收字符串类型

### 代码实现

**请求处理**（以用户创建为例）：
```typescript
// 1. Schema定义 - 接收字符串
gender: Type.String({
  enum: ["0", "1", "2"],
  description: "性别（0-未知，1-男，2-女）",
})

// 2. 模型层转换 - 字符串转数字
const genderNum = gender ? parseInt(gender, 10) : 0;

// 3. 数据库存储 - 数字类型
gender: genderNum,
```

**响应处理**（以用户查询为例）：
```typescript
// 1. 数据库查询 - 数字类型
const sysUser = await this.prisma.sysUser.findFirst({...});

// 2. 模型层转换 - 数字转字符串
gender: sysUser.gender.toString(),
status: sysUser.status.toString(),

// 3. 响应返回 - 字符串类型
return {
  gender: "1",  // 字符串类型
  status: "1",  // 字符串类型
}
```

## API接口规范

### 字典类型管理接口

- **GET /api/v1/admin/dicts/types** - 获取字典类型列表
- **GET /api/v1/admin/dicts/types/:id** - 获取字典类型详情
- **POST /api/v1/admin/dicts/types** - 创建字典类型
- **PUT /api/v1/admin/dicts/types/:id** - 更新字典类型
- **DELETE /api/v1/admin/dicts/types/:id** - 删除字典类型

### 字典数据管理接口

- **GET /api/v1/admin/dicts/data** - 获取字典数据列表
- **GET /api/v1/admin/dicts/data/:id** - 获取字典数据详情
- **POST /api/v1/admin/dicts/data** - 创建字典数据
- **PUT /api/v1/admin/dicts/data/:id** - 更新字典数据
- **DELETE /api/v1/admin/dicts/data/:id** - 删除字典数据

### 字典数据映射接口

- **GET /api/v1/admin/dicts/data/map** - 获取全部字典数据映射（用于前端下拉框等）

## 缓存策略

字典数据采用Redis缓存策略：

1. **缓存键**：`dict:data:map`
2. **缓存内容**：所有启用的字典数据，按字典类型分组
3. **缓存时间**：默认TTL（可配置）
4. **缓存清除**：字典数据变更时自动清除缓存

## 使用示例

### 前端使用

```javascript
// 获取字典数据映射
const dictMap = await getDictDataMap();

// 使用字典数据
const genderOptions = dictMap.user_gender;
// 返回: [{label: '保密', value: '0'}, {label: '男', value: '1'}, {label: '女', value: '2'}]

// 显示标签
const genderLabel = genderOptions.find(item => item.value === user.gender)?.label;
```

### 后端使用

```typescript
// 获取字典数据
const genderDict = await DictService.getAllDictDataMap();

// 使用字典数据进行验证
const genderOptions = genderDict.user_gender.map(item => item.value);
if (!genderOptions.includes(userGender)) {
  throw new Error('无效的性别值');
}
```

## 扩展规范

### 新增字典类型规范

1. **命名规范**：使用小写字母和下划线，如 `order_status`
2. **值规范**：使用连续的整数，从0开始
3. **标签规范**：简洁明了，避免歧义
4. **排序规范**：按照业务逻辑排序，常用项靠前

### 字典数据维护规范

1. **状态管理**：禁用状态的字典数据不参与业务逻辑
2. **默认值设置**：每个字典类型建议设置一个默认值
3. **标签样式**：可选设置，用于前端显示样式控制
4. **备注说明**：详细说明字典项的业务含义

## 注意事项

1. **类型一致性**：确保前后端数据类型转换的一致性
2. **缓存同步**：字典数据变更后及时清除缓存
3. **状态检查**：业务逻辑中需要检查字典数据的状态
4. **默认值处理**：合理设置和使用默认值
5. **国际化支持**：标签文本需要考虑国际化需求