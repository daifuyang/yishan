# 定时清理过期Token接口说明

## 概述

本文档描述了用于定时清理过期JWT Token的API接口，该接口设计为通过外部定时任务（如Linux cron或FC定时触发器）调用。

## 接口信息

### 清理过期Token接口

- **URL**: `/api/v1/system/cleanup-tokens`
- **Method**: `POST`
- **描述**: 清理系统中过期的JWT Token
- **鉴权方式**: 固定Token鉴权（通过请求体传递）

### 获取Token统计信息接口

- **URL**: `/api/v1/system/token-stats`
- **Method**: `GET`
- **描述**: 获取系统中Token的统计信息
- **鉴权方式**: 无鉴权（可根据需要添加）

## 请求参数

### 清理过期Token请求体

```json
{
  "cron_token": "your-cron-token-here",
  "days_to_keep": 30
}
```

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| cron_token | string | 是 | 定时任务令牌，用于接口鉴权 |
| days_to_keep | integer | 否 | 保留天数，默认30天，范围1-365 |

## 响应参数

### 成功响应

```json
{
  "success": true,
  "code": 10000,
  "message": "过期token清理成功",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "data": {
    "deletedCount": 150,
    "revokedCount": 75,
    "message": "成功清理150个过期token，撤销75个过期token"
  }
}
```

### 错误响应

```json
{
  "success": false,
  "code": 25001,
  "message": "无效的定时任务令牌",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

## 环境配置

在 `.env` 文件中添加以下配置：

```bash
# 定时任务配置
CRON_TOKEN=your-cron-token-change-this-in-production
```

## 使用示例

### cURL 示例

```bash
# 清理过期token
curl -X POST http://localhost:3000/api/v1/system/cleanup-tokens \
  -H "Content-Type: application/json" \
  -d '{
    "cron_token": "your-cron-token",
    "days_to_keep": 30
  }'

# 获取token统计信息
curl http://localhost:3000/api/v1/system/token-stats
```

### Node.js 示例

```javascript
const axios = require('axios');

// 清理过期token
async function cleanupTokens() {
  try {
    const response = await axios.post('http://localhost:3000/api/v1/system/cleanup-tokens', {
      cron_token: 'your-cron-token',
      days_to_keep: 30
    });
    console.log('清理结果:', response.data);
  } catch (error) {
    console.error('清理失败:', error.response.data);
  }
}
```

## Linux定时任务配置

### 1. 编辑crontab

```bash
# 每天凌晨2点执行清理任务
crontab -e
```

### 2. 添加定时任务

```bash
# 每天凌晨2点清理过期token（保留30天）
0 2 * * * /path/to/your/project/scripts/cleanup-tokens-cron.sh >> /var/log/token-cleanup.log 2>&1
```

### 3. 配置环境变量

在脚本中或通过crontab配置环境变量：

```bash
# 在crontab中添加
API_BASE_URL=http://your-api-domain.com
CRON_TOKEN=your-production-cron-token
DAYS_TO_KEEP=30
LOG_FILE=/var/log/token-cleanup.log
```

## 业务码说明

| 业务码 | 描述 | HTTP状态码 |
|--------|------|------------|
| 10000 | 操作成功 | 200 |
| 25001 | 无效的定时任务令牌 | 401 |
| 25002 | 定时任务执行失败 | 500 |
| 25003 | 权限不足 | 403 |

## 安全建议

1. **令牌安全**: 生产环境中使用强随机字符串作为CRON_TOKEN
2. **网络隔离**: 建议在内网或通过VPN访问该接口
3. **日志监控**: 监控清理任务的执行日志，及时发现异常
4. **频率控制**: 根据实际需求调整清理频率，避免过于频繁的清理操作
5. **备份策略**: 建议在清理前做好数据备份

## 性能考虑

- 清理操作会分批处理大量数据，建议避开业务高峰期
- 默认保留30天的过期token，可根据实际需求调整
- 建议每天执行一次清理任务，保持数据库性能

## 监控和告警

建议对接口调用情况进行监控：

- 清理数量异常（过多或过少）
- 接口调用失败
- 响应时间过长
- 数据库连接异常

## 扩展功能

可根据需要扩展以下功能：

- 清理用户会话数据
- 清理系统日志
- 清理临时文件
- 数据库优化和碎片整理